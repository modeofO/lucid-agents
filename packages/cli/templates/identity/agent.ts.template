{{ADAPTER_IMPORTS}}
import { walletsFromEnv } from "@lucid-agents/wallet";
import { createAgentIdentity, getTrustConfig } from "@lucid-agents/identity";

{{ADAPTER_PRE_SETUP}}
// Configure wallets for identity operations
const appOptions = {
  config: {
    wallets: walletsFromEnv(),
  },
};

{{ADAPTER_POST_SETUP}}
// Identity feature setup
// Note: Requires runtime.wallets.agent to be configured
// All other options (domain, autoRegister, rpcUrl, chainId) are read from process.env if not provided
const identity = await createAgentIdentity({
  runtime,
});

if (identity.didRegister) {
  console.log("Registered agent on-chain!");
  console.log("Transaction:", identity.transactionHash);

  // IMPORTANT: After registration, you MUST host the ERC-8004 metadata at the tokenURI
  // The tokenURI points to: https://{domain}/.well-known/agent-metadata.json
  // This metadata is what gets stored on-chain and allows others to verify your agent's identity
  const { generateAgentMetadata } = await import("@lucid-agents/identity");
  const metadata = generateAgentMetadata(identity, {
    name: process.env.AGENT_NAME,
    description: process.env.AGENT_DESCRIPTION || "An AI agent",
  });

  console.log("\n⚠️  IMPORTANT: Host this metadata at:");
  console.log(`   https://${identity.domain}/.well-known/agent-metadata.json\n`);
  console.log(JSON.stringify(metadata, null, 2));
  console.log("\nWhy? The ERC-8004 registry stores this URL as the tokenURI.");
  console.log("Anyone querying the registry will fetch this metadata to verify your agent's identity.");
  console.log("Without hosting this file, your agent's on-chain identity cannot be verified.\n");
} else if (identity.trust) {
  console.log("Found existing registration");
  console.log("Agent ID:", identity.record?.agentId);

  // Even if already registered, verify metadata is hosted
  if (identity.record?.tokenURI) {
    console.log("Token URI:", identity.record.tokenURI);
    console.log("Ensure metadata is hosted at the tokenURI location.");
  }
}

const trustConfig = getTrustConfig(identity);

// Example: Query validation summary (read operation)
// This demonstrates that the validation client is configured with the agent wallet
if (identity.clients?.validation && identity.record?.agentId) {
  console.log(
    "Fetching validation summary for agent ID:",
    identity.record.agentId.toString()
  );
  try {
    const summary = await identity.clients.validation.getSummary(
      identity.record.agentId
    );
    console.log("Validation summary:", {
      count: summary.count.toString(),
      averageResponse: summary.avgResponse,
    });
  } catch (error) {
    console.warn("Could not fetch validation summary:", error);
  }
} else {
  console.log("Validation client or agent ID not available:", {
    hasValidationClient: !!identity.clients?.validation,
    hasAgentId: !!identity.record?.agentId,
  });
}

// Example: Create validation request (write operation using agent wallet)
// This demonstrates write operations with the agent's private key
//
// IMPORTANT: The validatorAddress must be the address of a validator contract that will validate the request.
// This is typically a validator smart contract (e.g., stake-secured inference re-execution,
// zkML verifier, or TEE oracle). The validator will later respond with validationResponse.
//
// The agent (owner of agentId) calls this to request validation from a validator.
// The validator address should NOT be the agent's own address - it should be a separate validator.
//
// Note: This example uses a placeholder validator address for demonstration.
// In production, replace this with the actual validator contract address.
if (identity.clients?.validation && identity.record?.agentId) {
  try {
    const agentId = identity.record.agentId;

    // Placeholder validator address (replace with actual validator contract address in production)
    const validatorAddress =
      "0x0000000000000000000000000000000000000001" as const;

    // URI pointing to the validation request content (e.g., IPFS hash)
    const timestamp = Date.now();
    const requestUri = `https://${
      process.env.AGENT_DOMAIN || "agent.example.com"
    }/validation-request-${timestamp}.json`;

    console.log("Creating validation request...");
    console.log("Validator address:", validatorAddress);
    console.log("Agent ID:", agentId.toString());
    console.log("Request URI:", requestUri);

    // requestHash will be computed automatically from requestUri
    const txHash = await identity.clients.validation.createRequest({
      validatorAddress,
      agentId,
      requestUri,
    });
    console.log("Created validation request! Transaction:", txHash);
    console.log(
      "Note: The validator at",
      validatorAddress,
      "should respond with validationResponse"
    );
  } catch (error: any) {
    console.error("Could not create validation request:", error);
    if (error?.message) {
      console.error("Error message:", error.message);
    }
    if (error?.reason) {
      console.error("Error reason:", error.reason);
    }
  }
}

// Export identity feature clients
export const identityClient = identity.clients?.identity;
export const reputationClient = identity.clients?.reputation;
export const validationClient = identity.clients?.validation;

